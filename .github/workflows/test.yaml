name: ci
on:
  push:
    branches: ["main"]
  pull_request:

env:
  AIRFLOW_VERSION: 3.0.6

jobs:

  lint:
    name: Lint and type checks
    runs-on: ubuntu-latest
    steps:
      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: Cloning target repository
        uses: actions/checkout@v4

      - name: Run checks
        run: |
          uv run tox run -e lint
          uv run tox run -e type

  unit_test:
    name: Unit tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    steps:
      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      # Target repo is to be checked out first (order matters!)
      - name: Cloning target repository
        uses: actions/checkout@v4

      # Airflow's python plugin is not portable, thus we use it from the source
      - name: Clone Airflow sources, to enable Airflow pytset plugin
        uses: actions/checkout@v4
        with:
          repository: apache/airflow
          path: airflow
          ref: ${{ env.AIRFLOW_VERSION }}

      - name: Adjust Airflow version for local env
        run: |
          sed -e "s/<AIRFLOW_VERSION>/$AIRFLOW_VERSION/" pyproject.toml.template > pyproject.toml
          echo "Airflow Version is $AIRFLOW_VERSION"
        env:
          AIRFLOW_VERSION: ${{ env.AIRFLOW_VERSION}}

      - name: Run tests
        run: |
          export AIRFLOW_SOURCES=$PWD/airflow
          uv run tox run -e unit_test

  system_tests:
    name: System tests on local Nomad instance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup `nomad`
        uses: hashicorp/setup-nomad@main
        id: setup
        with:
          version: ${{ env.PRODUCT_VERSION }}

      - name: Run `nomad version`
        id: version
        run: "nomad version"

      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      # Target repo is to be checked out first (order matters!)
      - name: Cloning target repository
        uses: actions/checkout@v4

      # Airflow's python plugin is not portable, thus we use it from the source
      - name: Clone Airflow sources, to enable Airflow pytset plugin
        uses: actions/checkout@v4
        with:
          repository: apache/airflow
          path: airflow
          ref: ${{ env.AIRFLOW_VERSION }}

      - name: Adjust Airflow version for local env
        run: |
          sed -e "s/<AIRFLOW_VERSION>/$AIRFLOW_VERSION/" pyproject.toml.template > pyproject.toml
          echo "Airflow Version is $AIRFLOW_VERSION"
        env:
          AIRFLOW_VERSION: ${{ env.AIRFLOW_VERSION}}

      - name: Run tests
        run: |
          export AIRFLOW_SOURCES=$PWD/airflow
          export AIRFLOW_HOME=$PWD/tests/system/nomad/server/airflow_home

          uv run airflow db reset -y
          uv run airflow api-server -D
          uv run tox run -e system_test
